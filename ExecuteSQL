--SELECT * FROM [dbo].[emp_info]
--宣告Table變數,使用#TempTable也是可以的
Create TABLE #TempTable  
(
	ID			INT ,  --ROW序號
	TableName	NVARCHAR(100),
	ExecuteSQL	NVARCHAR(500)
)
--把需要處理的資料集選出來丟到Table變數中
INSERT INTO #TempTable ( ID,TableName,ExecuteSQL)
	( SELECT top 100 ROW_NUMBER() OVER(ORDER BY EMP_NO) AS ID,emp_ename,emp_id FROM [dbo].[emp_info])

--看一下現在@TempTable裡，已經塞好資料了		
SELECT * FROM  #TempTable  

DECLARE @TabelCount INT			 --loop的條件
	   ,@WhileTableCount INT = 1 
	   --
	   ,@Id      INT
	   ,@TableName NVARCHAR(100)
	   ,@ExecuteSQL NVARCHAR(500)
	   
SET @TabelCount = (SELECT COUNT(ID) FROM #TempTable)
--以下開始loop
WHILE @WhileTableCount <= @TabelCount
BEGIN
	
	--透過@WhileTableCount的定位取得每個row的值
	SELECT @Id = ID, @TableName = TableName, @ExecuteSQL = ExecuteSQL FROM #TempTable WHERE ID = @WhileTableCount
	
    ----Do Something Start----
	print @Id
	print @ExecuteSQL
	----Do Something End----
	
	--以下這句異常重要，忘記寫的話，SQL也是會跑無限迴圈的XD
	SET @WhileTableCount = @WhileTableCount + 1
END	

select * from [dbo].[emp_info] a
where not exists (
select ID from #TempTable b 
where a.emp_id = b.ExecuteSQL
)

--drop table #TempTable	


